<!DOCTYPE html>
<html>
<head>
    <title>LieferbestÃ¤tigung</title>
    https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js
    <style>
        body { font-family: Arial; margin: 20px; }
        canvas { border: 1px solid #000; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <h2>ğŸ“¦ Barcode scannen & unterschreiben</h2>
    <button onclick="startScanner()">ğŸ“· Barcode scannen</button>
    <div id="scanner" style="width:300px;height:200px;"></div>
    <p><strong>Lieferadresse:</strong> <span id="address"></span></p>
    <p><strong>Datum:</strong> <span id="date"></span></p>

    <h3>âœï¸ Unterschrift:</h3>
    <canvas id="signature" width="300" height="100"></canvas><br>
    <button onclick="clearSignature()">ğŸ§½ LÃ¶schen</button>
    <button id="sendBtn" onclick="submitData()" disabled>ğŸ“§ Senden</button>

    <script>
        const canvas = document.getElementById('signature');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let barcodeValid = false;

        canvas.addEventListener('mousedown', e => { drawing = true; ctx.beginPath(); });
        canvas.addEventListener('mouseup', e => { drawing = false; checkSignature(); });
        canvas.addEventListener('mousemove', draw);

        function draw(e) {
            if (!drawing) return;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            checkSignature();
        }

        function checkSignature() {
            const empty = ctx.getImageData(0, 0, canvas.width, canvas.height).data.every(pixel => pixel === 0);
            toggleSendButton(!empty && barcodeValid);
        }

        function toggleSendButton(enable) {
            document.getElementById('sendBtn').disabled = !enable;
        }

        // PrÃ¼fziffer-Validierung fÃ¼r NVE (SSCC)
        function isValidNVE(code) {
            if (!code.startsWith("00") || code.length < 20) return false;
            const sscc = code.slice(2);
            if (sscc.length !== 18) return false;

            const digits = sscc.split('').map(Number);
            const checkDigit = digits.pop();
            let sum = 0;
            let multiplier = 3;

            for (let i = digits.length - 1; i >= 0; i--) {
                sum += digits[i] * multiplier;
                multiplier = multiplier === 3 ? 1 : 3;
            }

            const calculated = (10 - (sum % 10)) % 10;
            return calculated === checkDigit;
        }

        function startScanner() {
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#scanner') },
                decoder: { readers: ["code_128_reader", "ean_reader", "ean_8_reader"] }
            }, function(err) {
                if (err) return console.error(err);
                Quagga.start();
            });

            Quagga.onDetected(data => {
                const code = data.codeResult.code;

                if (isValidNVE(code)) {
                    document.getElementById('address').textContent = `âœ… NVE gÃ¼ltig: ${code}`;
                    barcodeValid = true;
                } else {
                    document.getElementById('address').textContent = `âŒ UngÃ¼ltige NVE: ${code}`;
                    barcodeValid = false;
                }

                document.getElementById('date').textContent = new Date().toLocaleString();
                Quagga.stop();
                checkSignature();
                document.getElementById('signature').scrollIntoView({ behavior: 'smooth' });
            });
        }

        function submitData() {
            if (!barcodeValid) {
                alert("Bitte zuerst einen gÃ¼ltigen NVE-Barcode scannen!");
                return;
            }

            const empty = ctx.getImageData(0, 0, canvas.width, canvas.height).data.every(pixel => pixel === 0);
            if (empty) {
                alert("Bitte unterschreiben, bevor Sie senden!");
                return;
            }

            const address = document.getElementById('address').textContent;
            const date = document.getElementById('date').textContent;
            const signature = canvas.toDataURL();

            fetch('/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address, date, signature })
            }).then(res => res.text()).then(alert);
        }
    </script>
</body>
</html>
